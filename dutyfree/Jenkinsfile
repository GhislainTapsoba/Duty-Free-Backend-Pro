pipeline {
    agent any
    
    tools {
        maven 'Maven 3.9'
        jdk 'JDK 17'
    }
    
    environment {
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE = 'djbc/duty-free-backend'
        SONAR_HOST_URL = 'https://sonarcloud.io'
        VERSION = sh(script: 'mvn help:evaluate -Dexpression=project.version -q -DforceStdout', returnStdout: true).trim()
        MAVEN_OPTS = '-Dmaven.repo.local=.m2/repository'
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean compile -B -V'
            }
        }
        
        stage('Tests') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        sh 'mvn test -B'
                    }
                    post {
                        always {
                            junit '**/target/surefire-reports/*.xml'
                            publishHTML(target: [
                                reportDir: 'target/surefire-reports',
                                reportFiles: 'index.html',
                                reportName: 'Unit Test Report'
                            ])
                        }
                    }
                }
                
                stage('Integration Tests') {
                    steps {
                        sh 'mvn verify -B -DskipUnitTests'
                    }
                    post {
                        always {
                            junit '**/target/failsafe-reports/*.xml'
                            publishHTML(target: [
                                reportDir: 'target/failsafe-reports',
                                reportFiles: 'index.html',
                                reportName: 'Integration Test Report'
                            ])
                        }
                    }
                }
            }
        }
        
        stage('Code Coverage') {
            steps {
                sh 'mvn jacoco:report'
            }
            post {
                always {
                    jacoco(
                        execPattern: 'target/*.exec',
                        classPattern: 'target/classes',
                        sourcePattern: 'src/main/java',
                        exclusionPattern: 'src/test*'
                    )
                }
            }
        }
        
        stage('SonarQube Analysis') {
            when {
                branch 'main'
            }
            steps {
                withSonarQubeEnv('SonarCloud') {
                    sh '''
                        mvn sonar:sonar \
                            -Dsonar.projectKey=duty-free-backend \
                            -Dsonar.organization=djbc \
                            -Dsonar.host.url=${SONAR_HOST_URL}
                    '''
                }
            }
        }
        
        stage('Quality Gate') {
            when {
                branch 'main'
            }
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        
        stage('Security Scan') {
            parallel {
                stage('Dependency Check') {
                    steps {
                        dependencyCheck additionalArguments: '''
                            --scan .
                            --format HTML
                            --format XML
                            --project duty-free-backend
                        ''', odcInstallation: 'OWASP Dependency Check'
                        
                        dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                    }
                }
                
                stage('Trivy Scan') {
                    steps {
                        sh 'trivy fs --exit-code 0 --no-progress .'
                    }
                }
            }
        }
        
        stage('Package') {
            steps {
                sh 'mvn package -DskipTests -B'
            }
            post {
                success {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Docker Build and Push') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            stages {
                stage('Validate Dockerfile') {
                    steps {
                        sh 'hadolint Dockerfile'
                    }
                }
                
                stage('Build and Push Image') {
                    steps {
                        script {
                            docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-credentials') {
                                def tag = env.BRANCH_NAME == 'main' ? VERSION : "${VERSION}-${env.BUILD_NUMBER}"
                                def customImage = docker.build("${DOCKER_IMAGE}:${tag}")
                                customImage.push()
                                
                                if (env.BRANCH_NAME == 'main') {
                                    customImage.push('latest')
                                }
                            }
                        }
                    }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    sshagent(['ssh-staging-credentials']) {
                        sh '''
                            ssh -o StrictHostKeyChecking=no staging@staging.dutyfree.com << 'EOF'
                                cd /opt/duty-free-backend
                                git pull origin develop
                                docker-compose pull
                                docker-compose up -d
                                sleep 30
                                curl -f http://localhost:8080/actuator/health || exit 1
                            EOF
                        '''
                    }
                }
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to Production?', ok: 'Deploy'
                
                script {
                    sshagent(['ssh-prod-credentials']) {
                        sh '''
                            ssh -o StrictHostKeyChecking=no prod@dutyfree.com << 'EOF'
                                cd /opt/duty-free-backend
                                ./backup.sh
                                git pull origin main
                                ./deploy.sh
                            EOF
                        '''
                    }
                }
            }
        }
        
        stage('Post-Deployment Tests') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            parallel {
                stage('Smoke Tests') {
                    steps {
                        script {
                            def targetUrl = env.BRANCH_NAME == 'main' ? 
                                'https://dutyfree.com' : 'https://staging.dutyfree.com'
                            
                            sh """
                                curl -f ${targetUrl}/actuator/health || exit 1
                                curl -f ${targetUrl}/actuator/metrics || exit 1
                            """
                        }
                    }
                }
                
                stage('Performance Tests') {
                    steps {
                        script {
                            def targetUrl = env.BRANCH_NAME == 'main' ? 
                                'https://dutyfree.com' : 'https://staging.dutyfree.com'
                            
                            sh """
                                k6 run performance-tests/load-test.js \
                                    -e TARGET_URL=${targetUrl} \
                                    --summary-export=k6-summary.json
                            """
                        }
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'k6-summary.json', fingerprint: true
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            script {
                def message = """
                    :white_check_mark: *Build Successful*
                    *Job:* ${env.JOB_NAME} #${env.BUILD_NUMBER}
                    *Branch:* ${env.BRANCH_NAME}
                    *Duration:* ${currentBuild.durationString}
                    *Test Results:* ${currentBuild.rawBuild.getAction(hudson.tasks.junit.TestResultAction.class)?.totalCount ?: 'N/A'} tests run
                    *Coverage:* ${currentBuild.rawBuild.getAction(hudson.plugins.jacoco.JacocoBuildAction.class)?.percentage ?: 'N/A'}%
                    
                    <${env.BUILD_URL}|View Build Details>
                """
                slackSend(color: 'good', message: message)
            }
        }
        failure {
            script {
                def message = """
                    :x: *Build Failed*
                    *Job:* ${env.JOB_NAME} #${env.BUILD_NUMBER}
                    *Branch:* ${env.BRANCH_NAME}
                    *Duration:* ${currentBuild.durationString}
                    *Failed Stage:* ${currentBuild.result}
                    
                    <${env.BUILD_URL}|View Build Details>
                    <${env.BUILD_URL}console|View Console Output>
                """
                slackSend(color: 'danger', message: message)
            }
        }
        unstable {
            script {
                def message = """
                    :warning: *Build Unstable*
                    *Job:* ${env.JOB_NAME} #${env.BUILD_NUMBER}
                    *Branch:* ${env.BRANCH_NAME}
                    *Duration:* ${currentBuild.durationString}
                    *Test Results:* ${currentBuild.rawBuild.getAction(hudson.tasks.junit.TestResultAction.class)?.failCount ?: 'N/A'} failures
                    
                    <${env.BUILD_URL}|View Build Details>
                """
                slackSend(color: 'warning', message: message)
            }
        }
    }
}